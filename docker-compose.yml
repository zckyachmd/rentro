services:
  web:
    container_name: rentro_web
    image: nginx:stable
    ports:
      - "${APP_HTTP_PORT:-8888}:80"
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - app_shared:/var/www/html:ro
    healthcheck:
      test: ["CMD-SHELL", "nginx -t >/dev/null 2>&1 || exit 1; pid=$$(cat /var/run/nginx.pid 2>/dev/null) || exit 1; kill -0 $$pid 2>/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      app:
        condition: service_healthy
    restart: unless-stopped
    networks:
      default:
        ipv4_address: 172.20.0.10

  app:
    container_name: rentro_app
    build:
      context: .
      target: app-runner
    volumes:
      - app_shared:/var/www/html
    environment:
      DB_CONNECTION: pgsql
      APP_KEY: ${APP_KEY}
      APP_URL: ${APP_URL:-http://localhost:${APP_HTTP_PORT:-8888}}
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-app}
      DB_USERNAME: ${DB_USERNAME:-app}
      DB_PASSWORD: ${DB_PASSWORD:-secret}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_CLIENT: phpredis
      INERTIA_SSR_ENABLED: ${INERTIA_SSR_ENABLED:-true}
      INERTIA_SSR_URL: ${INERTIA_SSR_URL:-http://ssr:13714}
    healthcheck:
      test: ["CMD", "php", "-r", "exit((int)!@fsockopen('127.0.0.1', (int)(getenv('FPM_PORT')?:9000)));"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
      ssr:
        condition: service_healthy
    restart: unless-stopped
    stop_grace_period: 15s
    networks:
      default:
        ipv4_address: 172.20.0.11

  redis:
    container_name: rentro_redis
    image: redis:7
    command: ["redis-server","--save","","--appendonly","no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      default:
        ipv4_address: 172.20.0.12

  db:
    container_name: rentro_db
    image: postgres:16
    ports:
      - "${DB_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: ${DB_DATABASE:-app}
      POSTGRES_USER: ${DB_USERNAME:-app}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secret}
    volumes: ["pg_data:/var/lib/postgresql/data"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \"$${POSTGRES_USER}\" -d \"$${POSTGRES_DB}\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      default:
        ipv4_address: 172.20.0.13

  ssr:
    container_name: rentro_ssr
    build:
      context: .
      target: ssr-runner
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({host:'127.0.0.1',port:process.env.PORT||13714,path:'/'},r=>process.exit(0)).on('error',()=>process.exit(1)).end()"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 15s
    environment:
      NODE_ENV: production
      PORT: 13714
      NODE_OPTIONS: --max-old-space-size=512
      SSR_ENTRY: bootstrap/ssr/ssr.js
    restart: unless-stopped
    networks:
      default:
        ipv4_address: 172.20.0.14

  horizon:
    container_name: rentro_horizon
    build:
      context: .
      target: app-runner
    command: ["php", "artisan", "horizon"]
    volumes:
      - app_shared:/var/www/html
    environment:
      DB_CONNECTION: pgsql
      APP_KEY: ${APP_KEY}
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-app}
      DB_USERNAME: ${DB_USERNAME:-app}
      DB_PASSWORD: ${DB_PASSWORD:-secret}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_CLIENT: phpredis
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
    healthcheck:
      test: ["CMD-SHELL", "php artisan horizon:status | grep -iqE 'running|active'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      app:
        condition: service_healthy
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      default:
        ipv4_address: 172.20.0.15

  scheduler:
    container_name: rentro_scheduler
    build:
      context: .
      target: app-runner
    command: ["php", "artisan", "schedule:work", "--no-interaction"]
    volumes:
      - app_shared:/var/www/html
    environment:
      DB_CONNECTION: pgsql
      APP_KEY: ${APP_KEY}
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-app}
      DB_USERNAME: ${DB_USERNAME:-app}
      DB_PASSWORD: ${DB_PASSWORD:-secret}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_CLIENT: phpredis
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep '[s]chedule:work' > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      app:
        condition: service_healthy
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      default:
        ipv4_address: 172.20.0.16

volumes:
  app_shared:
  pg_data:

networks:
  default:
    name: rentro-net
    ipam:
      config:
        - subnet: 172.20.0.0/24
